---
title: "4-association"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
html_document:
df_print: paged
---
- Perform association analysis on covariates
- PERMANOVA
- Maaslin2

```{r setup, echo = FALSE}                                           
knitr::opts_knit$set(root.dir = normalizePath(".."))
```
```{r setup2, message=FALSE, warning=FALSE, echo = FALSE}
for(i.function in list.files("functions/", full.names = TRUE)) {
  source(i.function)
}
setup(getwd())
dir_output <- "results/4-association/"
dir.create(dir_output, recursive = TRUE, showWarnings = FALSE)
```
# PERMANOVA
```{r PERMANOVA}
print(studies)
load("data/phyloseq/genera_adj.RData")
load("data/distance/distance_genera_adj.RData")
n_permutations <- 2 # set # permuations for PERMANOVA

metadata <- sample_data2(phylo_genera_adj)
# manipulate variables to test, so that avoid missing values
metadata_test <- metadata %>% 
  dplyr::mutate(B.cat_fill = fill_na(B.cat),
                L.cat_fill = fill_na(L.cat),
                E.cat_fill = fill_na(E.cat),
                race_fill = fill_na(race),
                gender_fill = fill_na(gender),
                age.cat_fill = 
                  dplyr::case_when(age < 18 ~ "child",
                                   !is.na(age) ~ "adult",
                                   TRUE ~ NA_character_) %>% fill_na,
                age_at_diagnosis.cat_fill = 
                  dplyr::case_when(age_at_diagnosis < 18 ~ "A1",
                                   age_at_diagnosis < 40 ~ "A2",
                                   !is.na(age_at_diagnosis) ~ "A3",
                                   TRUE ~ NA_character_) %>% fill_na,
                antibiotics_fill = fill_na(antibiotics),
                immunosuppressants_fill = fill_na(immunosuppressants),
                steroids_fill = fill_na(steroids),
                mesalamine_5ASA_fill = fill_na(mesalamine_5ASA))

# whole bunch of PERMANOVA fits
l_fit_adonisMarg <- paste0(c("race", 
                             "gender", 
                             "age.cat", 
                             "age_at_diagnosis.cat"), "_fill") %>% 
  purrr::map(function(variable) {
    as.formula(paste0("dist_genera_adj~(", variable,
                      "==\"NA\")", "+", variable)) %>% 
      vegan::adonis(data = metadata_test, permutations = n_permutations)
  })
l_fit_adonisCond <- paste0(c("B.cat", "L.cat", "E.cat", 
                             "antibiotics",
                             "immunosuppressants",
                             "steroids",
                             "mesalamine_5ASA"), "_fill") %>% 
  purrr::map(function(variable) {
    as.formula(paste0("dist_genera_adj~disease+(", variable,
                      "==\"NA\")", "+", variable)) %>% 
      vegan::adonis(data = metadata_test, permutations = n_permutations)
  })
fit_adonis_disease <- 
  vegan::adonis(dist_genera_adj~disease,
                data = metadata_test, permutations = n_permutations)
fit_adonis_bodySite <- 
  vegan::adonis(dist_genera_adj~sample_type + body_site,
                data = metadata_test, permutations = n_permutations)
fit_adonis_subject <- 
  vegan::adonis(dist_genera_adj~dataset_name + subject_accession,
                data = metadata_test, permutations = n_permutations)

tb_marg <- c("race", 
             "gender", 
             "age.cat", 
             "age_at_diagnosis.cat") %>% 
  purrr::map2_dfr(l_fit_adonisMarg, function(variable, i_fit_adonis) {
    tibble::tibble(R2 = i_fit_adonis$aov.tab$R2[1:2],
                   variable = variable,
                   is_NA = c("is_NA", "non_missing"))
  })
tb_cond <-c("B.cat", "L.cat", "E.cat", 
            "antibiotics",
            "immunosuppressants",
            "steroids",
            "mesalamine_5ASA") %>% 
  purrr::map2_dfr(l_fit_adonisCond, function(variable, i_fit_adonis) {
    tibble::tibble(R2 = i_fit_adonis$aov.tab$R2[2:3],
                   variable = variable,
                   is_NA = c("is_NA", "non_missing"))
  })
tb_disease <- tibble::tibble(R2 = fit_adonis_disease$aov.tab$R2[1], 
                             variable = "disease", is_NA = "non_missing")
tb_bodySite <- tibble::tibble(R2 = fit_adonis_bodySite$aov.tab$R2[1:2], 
                              variable = c("stool/biopsy", "biopsy_site"), 
                              is_NA = "non_missing")
tb_subject <- tibble::tibble(R2 = fit_adonis_subject$aov.tab$R2[1:2],
                             variable = c("study", "subject"),
                             is_NA = "non_missing")
tb_plot <- rbind(tb_bodySite, tb_marg, tb_disease, tb_cond, tb_subject) %>% 
  dplyr::mutate(variable = factor(variable, levels = rev(unique(variable))),
                is_NA = factor(is_NA, levels = c("non_missing", "is_NA")))
tb_plot %>% 
  ggplot(aes(x = is_NA, y = variable, fill = R2)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "black", trans = "log10") +
  geom_text(aes(label = round(R2*100, digits = 2) %>% paste0("%")), color = "navy")
ggsave(filename = paste0(dir_output, "PERMANOVA.pdf"), width = 5, height = 6)
```

# Maaslin2
```{r Maaslin2}
dir_outputChunk <- paste0(dir_output, "Maaslin2/")
dir.create(dir_outputChunk)
metadata_test <- metadata_test %>% 
  dplyr::mutate(study_site = paste(dataset_name, 
                                   sample_type, 
                                   sep = "_"),
                study_site_disease = paste0(dataset_name, 
                                            sample_type, 
                                            disease, sep = "_"),
                IBD = disease %>% 
                  dplyr::recode("CD" = "IBD",
                                "UC" = "IBD",
                                "control" = "control",
                                .default = NA_character_),
                subject_accession_longitudinal =
                  ifelse(dataset_name %in%
                           studies_longitudinal,
                         subject_accession,
                         NA_character_))
mat_otu_adj <- phylo_genera_adj %>% 
  transform_sample_counts(tss) %>%  
  otu_table2

# list of tests to carry out
source("assets/ma_tests.R")
l_results <- list()
for(test in names(l_tests)) {
  print(test)
  test_param <- l_tests[[test]]
  result <- fit_metaAnalysis(mat_otu = mat_otu_adj,
                                      data = metadata_test %>% 
                                        dplyr::filter(!!test_param$exprs_filter),
                                      test_variable = test_param$test_variable,
                                      contrasts = test_param$contrasts,
                                      batch_variable = test_param$batch_variable,
                                      covariates = test_param$covariates,
                                      covariates.random = test_param$covariates.random,
                                      moderator_variables = 
                                        test_param$moderator_variables,
                                      n_features = 50,
                                      normalization = "TSS",
                                      transform = "AST",
                                      analysis_method = "LM",
                                      rma_method = "REML",
                                      directory = paste0(dir_outputChunk, test, "/"),
                                      forest.plots = TRUE,
                                      verbose = FALSE)
  save(result, file = paste0(dir_outputChunk, test, "/result.RData"))
  l_results[[test]] <- result
}

df_test <- result$result$ind.results %>% 
  purrr::reduce(rbind) %>% 
  dplyr::filter(feature == "k__Archaea|p__Euryarchaeota|c__Methanobacteria|o__Methanobacteriales|f__Methanobacteriaceae|g__Methanobrevibacter|NA") %>% 
  dplyr::filter(!is.na(coef)) %>% 
  dplyr::mutate(moderator = 
                  batch %>% 
                  stringr::str_replace_all("^.*\\_", ""))
rma.test <- metafor::rma.uni(yi = df_test$coef,
                             sei = df_test$stderr,
                             method = "FE",
                             control = list(threshold = 1e-10))$I2
rma.test.mod <- metafor::rma.uni(yi = df_test$coef,
                                 sei = df_test$stderr,
                                 mod = ~.,
                                 data = df_test[, "moderator", drop = FALSE],
                                 method = "REML",
                                 control = list(threshold = 1e-10))
df_sim <- data.frame(yi = c(4, -4, 5, -5), sei = rep(1, 4),
                     mod = c(1, 1, 0, 0))
test <- metafor::rma.uni(df_sim$yi, sei = df_sim$sei, method = "ML")
test <- metafor::rma.uni(df_sim$yi, sei = df_sim$sei, mods = df_sim$mod, method = "ML")
dir_output.tmp <- paste0(dir_outputChunk, "Maaslin2/", test, "/")
dir.create(dir_output.tmp, recursive = TRUE, showWarnings = FALSE)



df_results <- l_results %>% 
  purrr::imap_dfr(
    function(i_result, test) {
      i_result$meta.results$`1` %>% 
        dplyr::select(Feature, Exposure, Coefficient, Standard.error, 
                      P.val, P.bonf, Q.fdr) %>% 
        dplyr::mutate(test = test)
    }
  )
tb_filter <- df_results %>% 
  dplyr::filter(!is.na(Coefficient)) %>% 
  dplyr::group_by(Feature) %>% 
  dplyr::summarise(min_Q = min(Q.fdr)) %>% 
  dplyr::arrange(min_Q)
# tb_filter <- df_results %>% 
#   dplyr::filter(!is.na(Coefficient), test == "IBD_vs_control") %>% 
#   dplyr::group_by(Feature) %>% 
#   dplyr::summarise(min_Q = min(Q.fdr)) %>% 
#   dplyr::arrange(min_Q)
taxa_sig <- tb_filter %>% dplyr::slice(1:30) %>% extract2("Feature")
df_plot <- df_results %>% 
  dplyr::filter(Feature %in% taxa_sig) %>% 
  dplyr::mutate(test = factor(test, 
                              levels = names(l_results)),
                Feature = factor(Feature,
                                 levels = rev(taxa_sig)))
df_plot <- df_plot %>% 
  dplyr::mutate(Coefficient = ifelse(Q.fdr < 0.05,
                                     Coefficient,
                                     NA))
p <- df_plot %>% 
  ggplot(aes(x = test, y = Feature, fill = Coefficient)) +
  geom_tile() +
  scale_fill_gradient2(low="blue", mid = "white", high="red", 
                       na.value="grey50")
ggsave(filename = "results/4-association/Maaslin2.pdf",
       p, width = 10, height = 8)
df_results %>% 
  dplyr::filter(test == "antibiotics") %>% 
  dplyr
```

