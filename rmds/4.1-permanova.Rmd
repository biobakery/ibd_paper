---
title: "4.1-association_permanova"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
html_document:
df_print: paged
---
# Overview
Perform PERMANOVA analysis on covariates.

```{r setup, echo = FALSE}                                           
knitr::opts_knit$set(root.dir = normalizePath(".."))
```
```{r setup2, message=FALSE, warning=FALSE, echo = FALSE}
rm(list = ls())
for(i.function in list.files("functions/", full.names = TRUE)) {
  source(i.function)
}
setup(getwd())
dir_output <- "results/4.1-permanova/"
dir.create(dir_output, recursive = TRUE, showWarnings = FALSE)
```

# PERMANOVA
```{r PERMANOVA}
print(studies)
dir_outputChunk <- paste0(dir_output, "PERMANOVA/")
dir.create(dir_outputChunk)
load("data/phyloseq/genera_adj.RData")
load("data/distance/dist_genera_adj.RData")
n_permutations <- 20 # set # permuations for PERMANOVA
ncores <- 20

metadata <- sample_data2(phylo_genera_adj)
metadata_test <- metadata %>% 
  dplyr::mutate(age.cat = 
                  dplyr::case_when(age < 18 ~ "child",
                                   !is.na(age) ~ "adult",
                                   TRUE ~ NA_character_),
                age_at_diagnosis.cat = 
                  dplyr::case_when(age_at_diagnosis < 18 ~ "A1",
                                   age_at_diagnosis < 40 ~ "A2",
                                   !is.na(age_at_diagnosis) ~ "A3",
                                   TRUE ~ NA_character_))

for(variable in c("race",
                  "gender",
                  "age.cat",
                  "age_at_diagnosis.cat")) {
  test <- fit_permanova_variable(D = dist_genera_adj, 
                               variable = variable,
                               variable_class = "subject",
                               block_covariates = NULL,
                               block_variable = "subject_accession",
                               data = metadata_test,
                               permutations = n_permutations, 
                               ncores = 20)
  assign(paste0("fit.permanova_", variable),
         test)
  save(list = paste0("fit.permanova_", variable),
       file = paste0(dir_output, variable, ".RData"))
  rm(list = c("test", paste0("fit.permanova_", variable)))
  }
```

