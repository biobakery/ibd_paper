---
title: "3-adjust_batch"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
---
- Calculate distances of samples (before and after adjustment)
- Adjust batch within studies (if available).
- Adjust batch across studies.
- Overview of studies.
* Heatmap of top abundant taxa
* Ordination
* Permanova quantification
```{r setup, echo = FALSE}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```
```{r setup2, message=FALSE, warning=FALSE, echo = FALSE}
for(i.function in list.files("functions/", full.names = TRUE)) {
  source(i.function)
}
setup(getwd())
dir_output <- "results/3-adjust_batch/"
dir.create(dir_output, recursive = TRUE, showWarnings = FALSE)
```
# Perform batch-correction on studies where available
```{r batch adjustment}
print(studies)
load("data/phyloseq/genera.RData")
mat_otu <- otu_table2(phylo_genera)
metadata <- sample_data2(phylo_genera)
studies_batch <- metadata %>% 
  dplyr::group_by(dataset_name) %>% 
  dplyr::summarise(has_batch = any(!is.na(batch))) %>% 
  dplyr::filter(has_batch) %>% 
  extract2("dataset_name")
mat_otu_adj <- mat_otu
dir.create(paste0(dir_output, "adjust.batch_batches/"), 
           recursive = TRUE, showWarnings = FALSE)
for(study in studies_batch) {
  samples_tmp <- rownames(metadata)[metadata$dataset_name == study &
                                      !is.na(metadata$batch)]
  cat("Study", study, "has", length(samples_tmp), " samples with",
      dplyr::n_distinct(metadata[samples_tmp, ]$batch), "batches.\n")
  mat_otu_tmp <- MMUPHin::adjust.batch(feature.count = mat_otu[, samples_tmp],
                                       batch = "batch",
                                       data = metadata[samples_tmp, ])
  ggsave(filename = paste0(dir_output, "adjust.batch_batches/", study, ".pdf"),
         width = 8, height = 4)
  mat_otu_adj[, samples_tmp] <- mat_otu_tmp
  # dist1 <- mat_otu[, samples_tmp] %>% otu_table(taxa_are_rows = TRUE) %>% 
  #   phyloseq::distance(method = "bray") 
  # dist2 <- mat_otu_tmp %>% otu_table(taxa_are_rows = TRUE) %>%
  #   phyloseq::distance(method = "bray") 
  # vegan::adonis(dist1 ~ batch, data = metadata[samples_tmp, ], permutations = 2) %>% print
  # vegan::adonis(dist2 ~ batch, data = metadata[samples_tmp, ], permutations = 2) %>% print
}
phylo_genera_adj <- phylo_genera
otu_table(phylo_genera_adj) <- otu_table(mat_otu_adj, taxa_are_rows = TRUE)
```
# Perform study adjustment
```{r study adjustment}
mat_otu_adj2 <- MMUPHin::adjust.batch(feature.count = mat_otu_adj,
                                      batch = "dataset_name",
                                      covariates = c("disease", "body_site"),
                                      data = metadata)
ggsave(filename = paste0(dir_output, "adjust.batch_studies.pdf"), 
       width = 8,
       height = 4)
phylo_genera_adj2 <- phylo_genera
otu_table(phylo_genera_adj2) <- otu_table(mat_otu_adj2, taxa_are_rows = TRUE)
dist_genera <- phylo_genera %>% 
  transform_sample_counts(tss) %>% 
  phyloseq::distance(method = "bray")
save(dist_genera, file = paste0(dir_output, "distance_genera.RData"))
dist_genera_adj <- phylo_genera_adj2 %>% 
  transform_sample_counts(tss) %>% 
  phyloseq::distance(method = "bray")
save(dist_genera_adj, file = paste0(dir_output, "distance_genera_adj.RData"))
vegan::adonis(dist_genera ~ dataset_name, data = metadata, permutations = 2)
vegan::adonis(dist_genera ~ body_site + disease + dataset_name, data = metadata, permutations = 2)

vegan::adonis(dist_genera_adj ~ dataset_name, data = metadata, permutations = 2)
vegan::adonis(dist_genera_adj ~ body_site + disease + dataset_name, data = metadata, permutations = 2)
```

Examine alpha diversity.
```{r "alpha diversity across studies"}
tb_long <- phylo_species_filtered %>% 
  transform_sample_counts(tss) %>% 
  phyloseq_to_tb()

dist_before
tb_rankFeature <- tb_long %>% 
  dplyr::group_by(feature) %>% 
  dplyr::summarise(mean_abundance = mean(abundance)) %>% 
  dplyr::mutate(rank = rank(-mean_abundance, ties.method = "min")) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(feature_select = rank <= 50)
tb_heatmap <- tb_long %>% 
  dplyr::left_join(tb_rankFeature, by = "feature") %>% 
  dplyr::filter(feature_select)

library(gplots)
mat_heatmap <- tb_heatmap %>% 
  dplyr::select(feature, rownames, abundance) %>% 
  tidyr::spread(key = rownames, value = abundance) %>% 
  tibble::column_to_rownames("feature") %>% 
  as.matrix()
heatmap.2(mat_heatmap)
tb_tmp <- studies %>% 
  purrr::map_dfr(function(study) {
    tibble::tibble(
      taxonamy = c("species",
                   "genera"),
      N_taxa = c(
        phyloseq::ntaxa(l_species[[study]]),
        phyloseq::ntaxa(l_genera[[study]])),
      N_samples = c(
        phyloseq::nsamples(l_species[[study]]),
        phyloseq::nsamples(l_genera[[study]])),
      median_log10LibSize = c(
        l_species[[study]] %>% 
          phyloseq::sample_sums() %>% 
          add(1) %>% 
          log10() %>% 
          median(),
        l_genera[[study]] %>% 
          phyloseq::sample_sums() %>% 
          add(1) %>% 
          log10() %>% 
          median()),
      study = study
    )
  })
p1 <- tb_tmp %>% 
  ggplot(aes(x = N_samples,
             y = N_taxa)) +
  geom_point() +
  ggrepel::geom_text_repel(aes(label = study)) +
  facet_wrap(~factor(taxonamy, levels = c("species", "genera")),
             scales = "free_y")
p2 <- tb_tmp %>% 
  ggplot(aes(x = median_log10LibSize,
             y = N_taxa)) +
  geom_point() +
  ggrepel::geom_text_repel(aes(label = study)) +
  facet_wrap(~factor(taxonamy, levels = c("species", "genera")),
             scales = "free_y")
print(p1)
print(p2)
plot_grid(p1, p2, nrow = 1) %>% 
  cowplot_title("Alpha diversity across studies") %>% 
  ggsave(file = paste0(dir.output, "fig_alphaDiversity.pdf"),
         width = 15,
         heigh = 5)
```
Examine uniquely present and absent taxa.
```{r "dataset specific species"}
uniqTaxa <- unique_taxa(phylo_species, name_study = "dataset_name")
uniqTaxa$tb_presence %>% 
  dplyr::filter(!duplicated(feature)) %>% 
  dplyr::group_by(n_present) %>% 
  dplyr::summarise(N = n()) %>% 
  t() %>% 
  DT::datatable()
(uniqTaxa$tb_uniqPres %>% 
    dplyr::arrange(study, mean_abundance) %>% 
    dplyr::mutate(feature = factor(feature, levels = feature)) %>% 
    ggplot(aes(x = feature, y = mean_abundance, color = study)) +
    geom_point() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))) %>% 
  ggsave(filename = paste0(dir.output, "fig_SpeciesUniquePresent.pdf"),
         plot = .,
         width = 40,
         height = 10)
(uniqTaxa$tb_uniqPres %>% 
    dplyr::filter(mean_abundance > 1e-4) %>% 
    dplyr::arrange(study, mean_abundance) %>% 
    dplyr::mutate(feature = factor(feature, levels = feature)) %>% 
    ggplot(aes(x = feature, y = mean_abundance, color = study)) +
    geom_point() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    coord_flip()) %>% 
  ggsave(filename = paste0(dir.output, "fig_SpeciesUniquePresentZoom.pdf"),
         plot = .,
         width = 15,
         height = 10)
(uniqTaxa$tb_uniqAbs %>% 
    dplyr::arrange(study, mean_abundance) %>% 
    dplyr::mutate(feature = factor(feature, levels = feature)) %>% 
    ggplot(aes(x = feature, y = mean_abundance, color = study)) +
    geom_point() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    coord_flip()) %>% 
  ggsave(filename = paste0(dir.output, "fig_SpeciesUniqueAbsent.pdf"),
         plot = .,
         width = 15,
         height = 10)

uniqTaxa <- unique_taxa(phylo_genera, name_study = "dataset_name")
uniqTaxa$tb_presence %>% 
  dplyr::filter(!duplicated(feature)) %>% 
  dplyr::group_by(n_present) %>% 
  dplyr::summarise(N = n()) %>% 
  t() %>% 
  DT::datatable()
(uniqTaxa$tb_uniqPres %>% 
    dplyr::arrange(study, mean_abundance) %>% 
    dplyr::mutate(feature = factor(feature, levels = feature)) %>% 
    ggplot(aes(x = feature, y = mean_abundance, color = study)) +
    geom_point() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1))) %>% 
  ggsave(filename = paste0(dir.output, "fig_GeneraUniquePresent.pdf"),
         plot = .,
         width = 40,
         height = 10)
(uniqTaxa$tb_uniqPres %>% 
    dplyr::filter(mean_abundance > 1e-4) %>% 
    dplyr::arrange(study, mean_abundance) %>% 
    dplyr::mutate(feature = factor(feature, levels = feature)) %>% 
    ggplot(aes(x = feature, y = mean_abundance, color = study)) +
    geom_point() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    coord_flip()) %>% 
  ggsave(filename = paste0(dir.output, "fig_GeneraUniquePresentZoom.pdf"),
         plot = .,
         width = 15,
         height = 10)
(uniqTaxa$tb_uniqAbs %>% 
    dplyr::arrange(study, mean_abundance) %>% 
    dplyr::mutate(feature = factor(feature, levels = feature)) %>% 
    ggplot(aes(x = feature, y = mean_abundance, color = study)) +
    geom_point() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    coord_flip()) %>% 
  ggsave(filename = paste0(dir.output, "fig_GeneraUniqueAbsent.pdf"),
         plot = .,
         width = 15,
         height = 10)

mat_tax_tmp <- tax_table2(l_species$Jansson_Lamendella_Crohns)
mat_tax_tmp %>% 
  tibble::as_tibble(rownames = "otu_cluster") %>% 
  dplyr::filter(Rank6 == "g__Oceanobacillus")
mat_tax_tmp <- tax_table2(l_species$MucosalIBD)
mat_tax_tmp %>% 
  tibble::as_tibble(rownames = "otu_cluster") %>% 
  dplyr::filter(Rank7 == "s__blattae")
```
```{r "Filter taxa"}
phylo_species_filtered <- phylo_species %>% 
  prune_taxaSamples(kOverA2(k = phyloseq::nsamples(phylo_species) * 0.01,
                            A = 1e-4))
phylo_genera_filtered <- phylo_species_filtered %>% 
  phyloseq::tax_glom("Rank6")
save(phylo_species_filtered, file = "data/phyloseq/species_filtered.RData")
save(phylo_genera_filtered, file = "data/phyloseq/genera_filtered.RData")
```


