---
title: "Summarise lm.meta simulation results"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
html_document:
df_print: paged
---
```{r setup, echo = FALSE}                                           
knitr::opts_knit$set(root.dir = normalizePath("../../"))
# setwd("simulation/")
```
```{r setup2, message=FALSE, warning=FALSE, echo = FALSE}
rm(list = ls())
for(i.function in c(list.files("functions/", full.names = TRUE),
                    list.files("functions/simulations/", full.names = TRUE))) {
  source(i.function)
}
setup("./")
dir_output <- "results/simulations/lm.meta/"
```

```{r load data for summary}
load(paste0(dir_output, "tb_sim.RData"))
load(paste0(dir_output, "evaluate_before.RData"))
load(paste0(dir_output, "evaluate_after.RData"))
```

```{r format simulation set up}
# effect sizes
tb_sim <- tb_sim %>% 
  dplyr::mutate(effect_exposure = disparity %>% 
                  factor(levels = c(0, 0.1, 0.2, 0.3, 0.4)),
                effect_batch = effectSize %>%
                  purrr::map_dbl("batch") %>% 
                  factor(levels = 0:10))
# nSample and nBatch
tb_sim <- tb_sim %>% 
  dplyr::arrange(nSample, nBatch) %>% 
  dplyr::mutate(nSample_nBatch = paste0("nSample = ", nSample, ", ",
                                        "nBatch = ", nBatch) %>% 
                  factor(levels = unique(.)))
# nMicrobe and percMicrobe spiked
tb_sim <- tb_sim %>% 
  dplyr::arrange(nMicrobe, spikeMicrobes) %>% 
  dplyr::mutate(nMicrobe_percSpike = paste0("nFeature = ", nMicrobe, ", ",
                                            spikeMicrobes*100, "% spiked") %>% 
                  factor(levels = unique(.)))
```

```{r summarise results}
# R2 sanity check
# aggregate results into df format
tb_R2 <- list(results, results_correct) %>% 
  purrr::map2_dfr(
    names(colors_base),
    ~ .x %>% 
      purrr::imap_dfr(
        ~ tibble::tibble(Variable = names(.x$R2),
                         R2 = .x$R2,
                         i = .y)
      ) %>% 
      dplyr::mutate(Data = .y)
    ) 
# format variables
tb_R2 <- tb_R2 %>% 
  dplyr::mutate(Variable = factor(Variable, 
                                  levels = c("batch", "exposure")),
                Data = factor(Data, levels = names(colors_base)))
# lm.meta results
# aggregate results into df format
tb_results <- list(results, results_correct) %>% 
  purrr::map2_dfr(
    names(colors_base),
    ~ .x %>% 
      purrr::imap_dfr(
        ~ tibble::tibble(model = c("MMUPHin", "naive"),
                         results = .x[c("MMUPHin", "naive")],
                         i = .y)
      ) %>% 
      dplyr::mutate(Data = .y)
  ) 
# format variables
tb_results <- tb_results %>% 
  dplyr::mutate(Data = factor(Data, levels = names(colors_base))) %>% 
  dplyr::mutate(Class = paste0(Data, ", ", model, " analyzed") %>% 
                  factor(levels = names(colors_simulation_lm.meta)))
# calculate FPR
tb_results <- tb_results %>% 
  dplyr::left_join(tb_sim, by = "i") %>% 
  dplyr::mutate(FPR = results %>% 
                  purrr::map_dbl(~sum(.x$pval < 0.05, na.rm = TRUE)) %>% 
                  magrittr::divide_by(nMicrobe))
# summarise mean and sd FPR across replicates
tb_summary <- tb_results %>%
  dplyr::group_by(i_setup, Class) %>% 
  dplyr::summarise(mean_FPR = mean(FPR),
                   sd_FPR = sd(FPR)) %>% 
  dplyr::ungroup()
```

```{r plot}
# R2 sanity check
tb_plot <- tb_R2 %>% dplyr::left_join(tb_sim, by = "i") %>% 
  dplyr::filter(!(effect_batch == 0 & Data == "MMUPHin corrected"))
for(i.effect in levels(tb_plot$effect_exposure)) {
  plist <- (1:nlevels(tb_plot$Variable)) %>% 
    purrr::map(function(i) {
      i.Variable <- levels(tb_plot$Variable)[i]
      p <- tb_plot %>% 
        dplyr::filter(Variable == i.Variable,
                      effect_exposure == i.effect) %>% 
        ggplot(aes(x = effect_batch, y = R2, color = Data)) +
        geom_boxplot() +
        facet_grid(nMicrobe_percSpike ~ nSample_nBatch) +
        scale_color_manual(values = colors_simulation_adjust.batch) +
        theme(legend.position = c(0, 1),
              legend.justification = c(0, 1),
              legend.background = element_blank(),
              strip.text = element_text(size = 8),
              legend.text = element_text(size = 8)) +
        xlab("Batch effect") +
        ggtitle(i.Variable)
      if(i >= 2)
        p <- p + theme(legend.position = "none")
      return(p)
    })
  cowplot::plot_grid(plotlist = plist,
                     nrow = 1) %>% 
    ggsave(paste0(dir_output, 
                  "R2_exposureImbalance_", 
                  as.numeric(i.effect)*2, 
                  ".pdf"),
           .,
           width = 15, height = 15)
}

# summary plot
tb_plot <- tb_summary %>% 
  dplyr::filter(!is.na(Class)) %>% 
  dplyr::left_join(dplyr::filter(tb_sim, !duplicated(i_setup)), 
                   by = "i_setup")
plist <- (1:nlevels(tb_sim$effect_exposure)) %>% 
    purrr::map(function(i) {
      i.effect <- levels(tb_sim$effect_exposure)[i]
      p <- tb_plot %>% 
        dplyr::filter(effect_exposure == i.effect) %>% 
        ggplot(aes(x = effect_batch, y = mean_FPR, color = Class)) +
        geom_point(size = 3, position = position_dodge(width = 1)) +
        geom_errorbar(aes(ymin = mean_FPR - sd_FPR, ymax = mean_FPR + sd_FPR),
                      position = position_dodge(width = 1)) +
        geom_hline(yintercept = 0.05, linetype = "dashed") +
        facet_grid(nMicrobe_percSpike ~ nSample_nBatch) +
        scale_color_manual(values = colors_simulation_lm.meta) +
        theme(legend.position = c(1, 1),
              legend.justification = c(1, 1),
              legend.background = element_blank(),
              legend.title = element_blank(),
              strip.text = element_text(size = 8),
              legend.text = element_text(size = 8)) +
        xlab("Batch effect") +
        ylab("False positive rate") +
        ggtitle(paste0("Exposure imbalance = ", 
                       i.effect %>% 
                         as.numeric %>% 
                         magrittr::multiply_by(200),
                       "%"))
      if(i != 3)
        p <- p + theme(legend.position = "none")
      return(p)
    })
cowplot::plot_grid(plotlist = plist,
                     nrow = 2) %>% 
    ggsave(paste0(dir_output, "summary.pdf"),
           .,
           width = 30, height = 30)
```
